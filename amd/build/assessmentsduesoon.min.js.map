{"version":3,"file":"assessmentsduesoon.min.js","sources":["../src/assessmentsduesoon.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript to initialise the Assessments due soon section.\n * We're using Chart.js v3.8.0 at present.\n *\n * @module     block_newgu_spdetails/assessmentsduesoon\n * @author     Greg Pedder <greg.pedder@glasgow.ac.uk>\n * @copyright  2024 University of Glasgow\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n\"use strict\";\n\nimport * as Log from 'core/log';\nimport * as ajax from 'core/ajax';\nimport {Chart, BarController} from 'core/chartjs';\nimport {exception as displayException} from 'core/notification';\nimport Templates from 'core/templates';\n\nconst Selectors = {\n    DUESOON_BLOCK: '#assessmentsDueSoonContainer',\n    COURSECONTENTS_BLOCK: '#courseTab-container',\n    ASSESSMENTSDUE_BLOCK: '#assessmentsDue-container',\n    ASSESSMENTSDUE_CONTENTS: '#assessmentsdue_content'\n};\n\nconst viewAssessmentsDueByChartType = function(chartItem, legendItem) {\n    const chartType = ((legendItem) ? legendItem.datasetIndex : chartItem);\n    Log.debug('chartType:' + chartType);\n\n    let containerBlock = document.querySelector(Selectors.COURSECONTENTS_BLOCK);\n    if (containerBlock.checkVisibility()) {\n        containerBlock.classList.add('hidden-container');\n    }\n\n    let assessmentsDueBlock = document.querySelector(Selectors.ASSESSMENTSDUE_BLOCK);\n    let assessmentsDueContents = document.querySelector(Selectors.ASSESSMENTSDUE_CONTENTS);\n    assessmentsDueBlock.classList.remove('hidden-container');\n\n    if (assessmentsDueBlock.children.length > 0) {\n        assessmentsDueContents.innerHTML = '';\n    }\n\n    assessmentsDueContents.insertAdjacentHTML(\"afterbegin\",\"<div class='loader d-flex justify-content-center'>\\n\" +\n        \"<div class='spinner-border' role='status'><span class='hidden'>Loading...</span></div></div>\");\n\n    ajax.call([{\n        methodname: 'block_newgu_spdetails_get_assessmentsduebytype',\n        args: {\n            charttype: chartType\n        },\n    }])[0].done(function(response) {\n        document.querySelector('.loader').remove();\n        let assessmentdata = JSON.parse(response.result);\n        Log.debug('data:' + assessmentdata.assessmentitems);\n        Templates.renderForPromise('block_newgu_spdetails/assessmentsdue', {data:assessmentdata})\n        .then(({html, js}) => {\n            Templates.appendNodeContents(assessmentsDueContents, html, js);\n            returnToAssessmentsHandler();\n        }).catch((error) => displayException(error));\n    }).fail(function(response) {\n        if(response) {\n            document.querySelector('.loader').remove();\n            let errorContainer = document.createElement('div');\n            errorContainer.classList.add('alert', 'alert-danger');\n\n            if(response.hasOwnProperty('message')) {\n                let errorMsg = document.createElement('p');\n\n                errorMsg.innerHTML = response.message;\n                errorContainer.appendChild(errorMsg);\n                errorMsg.classList.add('errormessage');\n            }\n\n            if(response.hasOwnProperty('moreinfourl')) {\n                let errorLinkContainer = document.createElement('p');\n                let errorLink = document.createElement('a');\n\n                errorLink.setAttribute('href', response.moreinfourl);\n                errorLink.setAttribute('target', '_blank');\n                errorLink.innerHTML = 'More information about this error';\n                errorContainer.appendChild(errorLinkContainer);\n                errorLinkContainer.appendChild(errorLink);\n                errorLinkContainer.classList.add('errorcode');\n            }\n\n            assessmentsDueContents.prepend(errorContainer);\n        }\n    });\n};\n\nconst returnToAssessmentsHandler = () => {\n    Log.debug('returnToAssessmentsHandler called');\n    if (document.querySelector('#assessments-due-return')) {\n        document.querySelector('#assessments-due-return').addEventListener('click', () => {\n            Log.debug('click event triggered');\n            let containerBlock = document.querySelector(Selectors.COURSECONTENTS_BLOCK);\n            let assessmentsDueBlock = document.querySelector(Selectors.ASSESSMENTSDUE_BLOCK);\n            assessmentsDueBlock.classList.add('hidden-container');\n            containerBlock.classList.remove('hidden-container');\n        });\n    }\n};\n\n/**\n * @method fetchAssessmentsDueSoon\n */\nconst fetchAssessmentsDueSoon = () => {\n    Chart.register(BarController);\n    let tempPanel = document.querySelector(Selectors.DUESOON_BLOCK);\n\n    tempPanel.insertAdjacentHTML(\"afterbegin\",\"<div class='loader d-flex justify-content-center'>\\n\" +\n        \"<div class='spinner-border' role='status'><span class='hidden'>Loading...</span></div></div>\");\n\n    ajax.call([{\n        methodname: 'block_newgu_spdetails_get_assessmentsduesoon',\n        args: {},\n    }])[0].done(function(response) {\n        document.querySelector('.loader').remove();\n        tempPanel.insertAdjacentHTML(\"afterbegin\", \"<canvas id='assessmentsDueSoonChart'\\n\" +\n            \" aria-label='Assessments Due Soon chart data' role='graphics-object'>\\n\" +\n            \"<p>The &lt;canvas&gt; element appears to be unsupported in your browser.</p>\\n\" +\n            \"</canvas>\");\n\n        const data = [\n            {\n                labeltitle: `24 hours:`,\n                value: response[0]['24hours']\n            },\n            {\n                labeltitle: `7 days:`,\n                value: response[0]['week']\n            },\n            {\n                labeltitle: `month:`,\n                value: response[0]['month']\n            }\n        ];\n\n        const chart = new Chart(\n            document.getElementById('assessmentsDueSoonChart'),\n            {\n                type: 'bar',\n                options: {\n                    responsive: true,\n                    indexAxis: 'y',\n                    scales: {\n                        x: {\n                            suggestedMin: 1,\n                            suggestedMax: 10\n                        }\n                    },\n                    plugins: {\n                        legend: {\n                            display: true,\n                            position: 'top',\n                            onClick: viewAssessmentsDueByChartType,\n                            labels: {\n                                usePointStyle: true,\n                                font: {\n                                    size: 20\n                                },\n                                generateLabels: (chart) => {\n                                    const datasets = chart.data.datasets;\n                                    return datasets[0].data.map((data, i) => ({\n                                        text: `${chart.data.labels[i]} ${data}`,\n                                        borderRadius: 0,\n                                        datasetIndex: i,\n                                        fillStyle: datasets[0].backgroundColor[i],\n                                        fontColor: '',\n                                        hidden: false,\n                                        lineCap: '',\n                                        lineDash: [],\n                                        lineDashOffset: 0,\n                                        lineJoin: '',\n                                        lineWidth: 0,\n                                        strokeStyle: datasets[0].backgroundColor[i],\n                                        pointStyle: 'rectRounded',\n                                        rotation: 0,\n                                        index: i\n                                    }));\n                                }\n                            },\n                        }\n                    },\n                },\n                data: {\n                    labels: data.map(row => row.labeltitle),\n                    datasets: [{\n                        data: data.map(row => row.value),\n                        indexAxis: 'y',\n                        backgroundColor: [\n                            'rgba(255,0,0,0.6)',\n                            'rgba(255,153,0,0.6)',\n                            'rgba(0,153,0,0.6)'\n                        ],\n                        borderColor: [\n                            'rgba(255,0,0)',\n                            'rgba(255,153,0)',\n                            'rgba(0,153,0)'\n                        ],\n                        borderWidth: 1,\n                        hoverOffset: 4\n                    }]\n                }\n            }\n        );\n\n        const canvas = document.getElementById('assessmentsDueSoonChart');\n        canvas.onclick = (evt) => {\n            const points = chart.getElementsAtEventForMode(\n                evt,\n                'nearest',\n                { intersect: true },\n                true\n              );\n              if (points.length === 0) {\n                return;\n              }\n              viewAssessmentsDueByChartType(points[0].index);\n          };\n\n    }).fail(function(err) {\n        document.querySelector('.loader').remove();\n        tempPanel.insertAdjacentHTML(\"afterbegin\",\"<div class='d-flex justify-content-center'>\\n\" +\n            err.message + \"</div>\");\n        Log.debug(err);\n    });\n};\n\n/**\n * @constructor\n */\nexport const init = () => {\n    fetchAssessmentsDueSoon();\n};"],"names":["Selectors","viewAssessmentsDueByChartType","chartItem","legendItem","chartType","datasetIndex","Log","debug","containerBlock","document","querySelector","checkVisibility","classList","add","assessmentsDueBlock","assessmentsDueContents","remove","children","length","innerHTML","insertAdjacentHTML","ajax","call","methodname","args","charttype","done","response","assessmentdata","JSON","parse","result","assessmentitems","renderForPromise","data","then","_ref","html","js","appendNodeContents","returnToAssessmentsHandler","catch","error","fail","errorContainer","createElement","hasOwnProperty","errorMsg","message","appendChild","errorLinkContainer","errorLink","setAttribute","moreinfourl","prepend","addEventListener","register","BarController","tempPanel","labeltitle","value","chart","Chart","getElementById","type","options","responsive","indexAxis","scales","x","suggestedMin","suggestedMax","plugins","legend","display","position","onClick","labels","usePointStyle","font","size","generateLabels","datasets","map","i","text","borderRadius","fillStyle","backgroundColor","fontColor","hidden","lineCap","lineDash","lineDashOffset","lineJoin","lineWidth","strokeStyle","pointStyle","rotation","index","row","borderColor","borderWidth","hoverOffset","onclick","evt","points","getElementsAtEventForMode","intersect","err","fetchAssessmentsDueSoon"],"mappings":"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"}